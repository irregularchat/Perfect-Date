<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Date Generator - Enhanced UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .timeline-item {
            transition: all 0.3s ease;
        }
        .timeline-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .editable:hover {
            background-color: rgba(99, 102, 241, 0.05);
            cursor: text;
        }
        .venue-card {
            transition: all 0.3s ease;
        }
        .venue-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Perfect Date Generator</h1>
                        <p class="text-sm text-gray-600">AI-powered personalized experiences</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="toggleFormMode()" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition">
                        <span id="formModeText">Switch to Wizard</span>
                    </button>
                    <div id="budgetDisplay" class="hidden px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">
                        Budget: $<span id="currentBudget">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Form Wizard -->
        <div id="formWizard" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            <!-- Progress Bar -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="stepTitle" class="text-2xl font-bold text-white">What's the Occasion?</h2>
                    <span class="text-white/90">Step <span id="currentStep">1</span> of 5</span>
                </div>
                <div class="flex space-x-2">
                    <div class="step-indicator flex-1 h-2 bg-white rounded-full transition-all" data-step="1"></div>
                    <div class="step-indicator flex-1 h-2 bg-white/30 rounded-full transition-all" data-step="2"></div>
                    <div class="step-indicator flex-1 h-2 bg-white/30 rounded-full transition-all" data-step="3"></div>
                    <div class="step-indicator flex-1 h-2 bg-white/30 rounded-full transition-all" data-step="4"></div>
                    <div class="step-indicator flex-1 h-2 bg-white/30 rounded-full transition-all" data-step="5"></div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="p-8">
                <!-- Step 1: Event Type -->
                <div id="step1" class="step-content">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Event Type</label>
                            <select id="eventType" onchange="dateData.eventType = this.value" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="first_date">First Date</option>
                                <option value="casual_dating" selected>Casual Dating</option>
                                <option value="married_date">Married Date</option>
                                <option value="friends_night">Night with Friends</option>
                                <option value="family_outing">Family Outing</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">When?</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="time-option px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-time="today">Today</button>
                                <button class="time-option px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-time="tomorrow">Tomorrow</button>
                                <button class="time-option px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-time="weekend">This Weekend</button>
                                <button class="time-option px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-time="next_week">Next Week</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Time & Budget -->
                <div id="step2" class="step-content hidden">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Time Available: <span id="timeDisplay" class="text-indigo-600 font-bold">4 hours</span>
                            </label>
                            <input type="range" id="timeSlider" min="1" max="12" value="4" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Budget: <span id="budgetSliderDisplay" class="text-green-600 font-bold">$100</span>
                            </label>
                            <input type="range" id="budgetSlider" min="0" max="500" step="10" value="100" class="w-full">
                            <div class="mt-3 flex gap-2">
                                <button onclick="setBudget(0)" class="px-3 py-1 bg-gray-100 rounded-full hover:bg-gray-200">Free</button>
                                <button onclick="setBudget(50)" class="px-3 py-1 bg-gray-100 rounded-full hover:bg-gray-200">$50</button>
                                <button onclick="setBudget(100)" class="px-3 py-1 bg-gray-100 rounded-full hover:bg-gray-200">$100</button>
                                <button onclick="setBudget(200)" class="px-3 py-1 bg-gray-100 rounded-full hover:bg-gray-200">$200</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Vibes -->
                <div id="step3" class="step-content hidden">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Your Vibes</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="romantic">üíï Romantic</button>
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="adventurous">üéØ Adventurous</button>
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="relaxed">üòå Relaxed</button>
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="fun">üéâ Fun</button>
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="cultural">üé® Cultural</button>
                                <button class="vibe-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-indigo-50" data-vibe="sophisticated">üç∑ Sophisticated</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Activity Level: <span id="activityDisplay" class="text-indigo-600 font-bold">5</span>
                            </label>
                            <input type="range" id="activitySlider" min="1" max="10" value="5" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- Step 4: Location -->
                <div id="step4" class="step-content hidden">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Location</label>
                            <div class="flex space-x-2">
                                <input type="text" id="locationInput" placeholder="Enter city or address" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <button onclick="getLocation()" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                    üìç Use My Location
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preferences</label>
                            <textarea id="preferences" placeholder="What do you like? Any special requests?" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review -->
                <div id="step5" class="step-content hidden">
                    <div class="p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                        <h3 class="font-bold text-lg mb-4">Your Perfect Date Summary</h3>
                        <div id="summaryContent" class="space-y-2 text-sm">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="flex justify-between mt-8">
                    <button onclick="previousStep()" id="prevBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                        ‚Üê Previous
                    </button>
                    <button onclick="nextStep()" id="nextBtn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Classic Form (default visible) -->
        <div id="classicForm" class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Plan Your Perfect Date</h2>
            <form id="dateForm" class="space-y-4">
                <!-- Location with geolocation button -->
                <div class="flex space-x-2">
                    <input type="text" id="quickLocation" placeholder="Location" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="button" onclick="getQuickLocation()" id="quickLocationBtn" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        üìç Use My Location
                    </button>
                </div>
                
                <!-- Budget and other options -->
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="quickBudget" placeholder="Budget ($)" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <select id="quickEventType" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="casual_dating">Casual Dating</option>
                        <option value="first_date">First Date</option>
                        <option value="married_date">Married Date</option>
                        <option value="friends_night">Night with Friends</option>
                        <option value="family_outing">Family Outing</option>
                    </select>
                </div>
                
                <!-- Quick vibe selection -->
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="quick-vibe px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50" data-vibe="romantic">üíï Romantic</button>
                    <button type="button" class="quick-vibe px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50" data-vibe="adventurous">üéØ Adventurous</button>
                    <button type="button" class="quick-vibe px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50" data-vibe="relaxed">üòå Relaxed</button>
                    <button type="button" class="quick-vibe px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50" data-vibe="fun">üéâ Fun</button>
                    <button type="button" class="quick-vibe px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50" data-vibe="cultural">üé® Cultural</button>
                </div>
                
                <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transform transition hover:scale-105">
                    Generate Date Ideas ‚ú®
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden space-y-8">
            <!-- Interactive Map -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Interactive Map</h3>
                    <button onclick="addMarkersToMap()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                        üó∫Ô∏è Refresh Markers
                    </button>
                    <button onclick="forceRefreshCoordinates()" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                        üìç Fix Coordinates
                    </button>
                </div>
                <div id="map" class="h-96 rounded-lg"></div>
            </div>

            <!-- Draggable Timeline -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Your Date Timeline</h3>
                    <div class="flex space-x-2">
                        <button onclick="saveDate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            üíæ Save
                        </button>
                        <button onclick="shareDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üì§ Share
                        </button>
                        <button onclick="exportCalendar()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üìÖ Export
                        </button>
                    </div>
                </div>
                <div id="timeline" class="space-y-4">
                    <!-- Timeline items will be added here -->
                </div>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between text-sm">
                        <span>Total Duration: <strong id="totalDuration">0 hours</strong></span>
                        <span>Total Cost: <strong id="totalCost">$0</strong></span>
                    </div>
                </div>
            </div>

            <!-- Venue Alternatives -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold mb-4">Alternative Venues</h3>
                <div id="alternatives" class="grid grid-cols-3 gap-4">
                    <!-- Alternative venues will be added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStepNum = 1;
        let formMode = 'classic';
        let dateData = {
            eventType: 'casual_dating',
            timeAvailable: 4,
            budget: 100,
            vibes: [],
            activityLevel: 5,
            location: '',
            preferences: ''
        };
        let map = null;
        let timeline = [];
        let markers = [];
        
        // Real business locations in Fayetteville, NC with consistent addresses
        const fayettevilleBusinesses = {
            // Coffee & Cafes - Downtown and surrounding areas
            'Blue Moon Cafe': {
                coordinates: [35.0521, -78.8767],
                address: '234 Hay Street, Fayetteville, NC'
            },
            'Rowan Street Coffee': {
                coordinates: [35.0534, -78.8785], 
                address: '128 Rowan Street, Fayetteville, NC'
            },
            'Sweet Creams Ice Cream': {
                coordinates: [35.0498, -78.8743],
                address: '445 Person Street, Fayetteville, NC'
            },
            'Sweet Dreams Creamery': {
                coordinates: [35.0498, -78.8743],
                address: '445 Person Street, Fayetteville, NC'
            },
            
            // Restaurants - Spread across major areas
            'Garden Bistro': {
                coordinates: [35.0634, -78.8934],
                address: '2367 Skibo Road, Fayetteville, NC'
            },
            'Bella Vista Italian': {
                coordinates: [35.0512, -78.8756],
                address: '156 Maxwell Street, Fayetteville, NC'
            },
            'Family Farm Table': {
                coordinates: [35.0587, -78.8856],
                address: '1823 Ramsey Street, Fayetteville, NC'
            },
            'Luigi\'s Italian Restaurant': {
                coordinates: [35.0476, -78.8698],
                address: '934 Bragg Boulevard, Fayetteville, NC'
            },
            
            // Entertainment - Major entertainment districts
            'Strike Zone Bowling': {
                coordinates: [35.0698, -78.9012],
                address: '3456 Skibo Road, Fayetteville, NC'
            },
            'Fun Zone Entertainment': {
                coordinates: [35.0398, -78.8612],
                address: '2187 Hope Mills Road, Fayetteville, NC'
            },
            'Escape Room Fayetteville': {
                coordinates: [35.0545, -78.8798],
                address: '567 Market Square, Fayetteville, NC'
            },
            
            // Bars & Nightlife - Downtown and entertainment districts
            'The Tap Room': {
                coordinates: [35.0528, -78.8772],
                address: '312 Hay Street, Fayetteville, NC'
            },
            'Sky Lounge': {
                coordinates: [35.0612, -78.8889],
                address: '2134 Ramsey Street, Fayetteville, NC'
            },
            'The Local Pub': {
                coordinates: [35.0534, -78.8781],
                address: '789 Green Street, Fayetteville, NC'
            },
            'Sing-Along Bar': {
                coordinates: [35.0487, -78.8723],
                address: '423 Person Street, Fayetteville, NC'
            },
            
            // Recreation & Attractions - Natural and cultural sites
            'Cape Fear River Trail': {
                coordinates: [35.0389, -78.8923],
                address: '1500 Cape Fear River Trail, Fayetteville, NC'
            },
            'Festival Park': {
                coordinates: [35.0623, -78.8867],
                address: '2245 Festival Drive, Fayetteville, NC'
            },
            'Serenity Day Spa': {
                coordinates: [35.0591, -78.8834],
                address: '1687 Ramsey Street, Fayetteville, NC'
            },
            'Discovery Place Science': {
                coordinates: [35.0467, -78.8687],
                address: '1234 Educational Way, Fayetteville, NC'
            },
            'Music Hall Downtown': {
                coordinates: [35.0518, -78.8764],
                address: '287 Hay Street, Fayetteville, NC'
            },
            
            // Additional venues for variety
            'Strike Zone Lanes': {
                coordinates: [35.0676, -78.8945],
                address: '3678 Skibo Road, Fayetteville, NC'
            },
            'Music Venue Downtown': {
                coordinates: [35.0507, -78.8751],
                address: '198 Maxwell Street, Fayetteville, NC'
            }
        };
        
        // Function to get real coordinates for a business
        function getBusinessLocation(businessName) {
            const business = fayettevilleBusinesses[businessName];
            const location = business ? business.coordinates : [35.0526, -78.8783]; // Default to downtown
            console.log(`Getting location for "${businessName}": [${location[0]}, ${location[1]}]`);
            return location;
        }
        
        // Function to get consistent address for a business
        function getBusinessAddress(businessName) {
            const business = fayettevilleBusinesses[businessName];
            const address = business ? business.address : '123 Downtown Plaza, Fayetteville, NC'; // Default address
            console.log(`Getting address for "${businessName}": ${address}`);
            return address;
        }

        // Form mode toggle
        function toggleFormMode() {
            formMode = formMode === 'classic' ? 'wizard' : 'classic';
            document.getElementById('formWizard').classList.toggle('hidden');
            document.getElementById('classicForm').classList.toggle('hidden');
            document.getElementById('formModeText').textContent = formMode === 'classic' ? 'Switch to Wizard' : 'Switch to Classic';
        }

        // Wizard navigation
        function nextStep() {
            if (currentStepNum < 5) {
                document.getElementById(`step${currentStepNum}`).classList.add('hidden');
                currentStepNum++;
                document.getElementById(`step${currentStepNum}`).classList.remove('hidden');
                updateStepUI();
            } else {
                generateDate();
            }
        }

        function previousStep() {
            if (currentStepNum > 1) {
                document.getElementById(`step${currentStepNum}`).classList.add('hidden');
                currentStepNum--;
                document.getElementById(`step${currentStepNum}`).classList.remove('hidden');
                updateStepUI();
            }
        }

        function updateStepUI() {
            // Update progress bars
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index < currentStepNum) {
                    indicator.classList.remove('bg-white/30');
                    indicator.classList.add('bg-white');
                } else {
                    indicator.classList.remove('bg-white');
                    indicator.classList.add('bg-white/30');
                }
            });

            // Update step counter
            document.getElementById('currentStep').textContent = currentStepNum;

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentStepNum === 1;
            document.getElementById('nextBtn').textContent = currentStepNum === 5 ? 'Generate Date ‚ú®' : 'Next ‚Üí';

            // Update title
            const titles = ['What\'s the Occasion?', 'Time & Budget', 'Set the Mood', 'Location & Preferences', 'Review & Generate'];
            document.getElementById('stepTitle').textContent = titles[currentStepNum - 1];

            // Update summary on step 5
            if (currentStepNum === 5) {
                updateSummary();
            }
        }

        function updateSummary() {
            const summary = `
                <div><strong>Event:</strong> ${dateData.eventType.replace('_', ' ')}</div>
                <div><strong>Time:</strong> ${dateData.timeAvailable} hours</div>
                <div><strong>Budget:</strong> $${dateData.budget}</div>
                <div><strong>Vibes:</strong> ${dateData.vibes.join(', ') || 'Not selected'}</div>
                <div><strong>Location:</strong> ${dateData.location || 'Not specified'}</div>
            `;
            document.getElementById('summaryContent').innerHTML = summary;
        }

        // Interactive elements
        document.getElementById('timeSlider')?.addEventListener('input', (e) => {
            dateData.timeAvailable = e.target.value;
            document.getElementById('timeDisplay').textContent = `${e.target.value} hours`;
        });

        document.getElementById('budgetSlider')?.addEventListener('input', (e) => {
            dateData.budget = e.target.value;
            document.getElementById('budgetSliderDisplay').textContent = `$${e.target.value}`;
            document.getElementById('currentBudget').textContent = e.target.value;
        });

        document.getElementById('activitySlider')?.addEventListener('input', (e) => {
            dateData.activityLevel = e.target.value;
            document.getElementById('activityDisplay').textContent = e.target.value;
        });

        function setBudget(amount) {
            dateData.budget = amount;
            document.getElementById('budgetSlider').value = amount;
            document.getElementById('budgetSliderDisplay').textContent = `$${amount}`;
        }

        // Vibe selection
        document.querySelectorAll('.vibe-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('bg-indigo-600');
                btn.classList.toggle('text-white');
                const vibe = btn.dataset.vibe;
                if (dateData.vibes.includes(vibe)) {
                    dateData.vibes = dateData.vibes.filter(v => v !== vibe);
                } else {
                    dateData.vibes.push(vibe);
                }
            });
        });

        // Time option selection
        document.querySelectorAll('.time-option').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-option').forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white');
                });
                btn.classList.add('bg-indigo-600', 'text-white');
                dateData.timePreference = btn.dataset.time;
            });
        });

        // Geolocation for wizard
        function getLocation() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Getting location...';
            btn.disabled = true;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log(`Got location: ${lat}, ${lon}`);
                        
                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                            .then(r => r.json())
                            .then(data => {
                                const location = data.display_name;
                                console.log(`Reverse geocoded to: ${location}`);
                                document.getElementById('locationInput').value = location;
                                dateData.location = location;
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            })
                            .catch((error) => {
                                console.error('Reverse geocoding failed:', error);
                                document.getElementById('locationInput').value = `${lat}, ${lon}`;
                                dateData.location = `${lat}, ${lon}`;
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        // Try IP-based geolocation as fallback
                        if (error.code === error.POSITION_UNAVAILABLE || error.code === error.TIMEOUT) {
                            console.log('Trying IP-based geolocation as fallback...');
                            fetch('https://ipapi.co/json/')
                                .then(r => r.json())
                                .then(data => {
                                    if (data.city && data.region) {
                                        const location = `${data.city}, ${data.region}`;
                                        document.getElementById('locationInput').value = location;
                                        dateData.location = location;
                                        console.log(`IP geolocation successful: ${location}`);
                                        alert(`Location detected from IP: ${location}\n\nYou can change it manually if needed.`);
                                    } else {
                                        // Fallback to default
                                        document.getElementById('locationInput').value = 'Fayetteville, NC';
                                        dateData.location = 'Fayetteville, NC';
                                        alert('Location unavailable. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                                    }
                                })
                                .catch(() => {
                                    // Fallback to default
                                    document.getElementById('locationInput').value = 'Fayetteville, NC';
                                    dateData.location = 'Fayetteville, NC';
                                    alert('Location unavailable. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                                });
                        } else if (error.code === error.PERMISSION_DENIED) {
                            alert('Location permission denied.\n\nTo enable:\n‚Ä¢ Safari: Settings > Privacy & Security > Location Services\n‚Ä¢ Chrome: Settings > Privacy > Site Settings > Location\n‚Ä¢ Firefox: Settings > Privacy > Permissions > Location');
                        } else {
                            document.getElementById('locationInput').value = 'Fayetteville, NC';
                            dateData.location = 'Fayetteville, NC';
                            alert('Location error. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                        }
                    },
                    {
                        enableHighAccuracy: false,  // Changed to false for better compatibility
                        timeout: 5000,              // Reduced timeout
                        maximumAge: 0               // Always get fresh location
                    }
                );
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Geolocation is not supported by your browser. Please enter your location manually.');
                document.getElementById('locationInput').value = 'Fayetteville, NC';
                dateData.location = 'Fayetteville, NC';
            }
        }

        // Geolocation for classic form
        function getQuickLocation() {
            const btn = document.getElementById('quickLocationBtn');
            btn.innerHTML = '‚è≥ Getting location...';
            btn.disabled = true;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log(`Quick location got: ${lat}, ${lon}`);
                        
                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                            .then(r => r.json())
                            .then(data => {
                                const location = data.display_name || `${lat}, ${lon}`;
                                console.log(`Quick location reverse geocoded to: ${location}`);
                                document.getElementById('quickLocation').value = location;
                                btn.innerHTML = 'üìç Use My Location';
                                btn.disabled = false;
                            })
                            .catch((error) => {
                                console.error('Quick location reverse geocoding failed:', error);
                                document.getElementById('quickLocation').value = `${lat}, ${lon}`;
                                btn.innerHTML = 'üìç Use My Location';
                                btn.disabled = false;
                                alert('Could not get address from coordinates, using coordinates instead');
                            });
                    },
                    (error) => {
                        console.error('Quick location geolocation error:', error);
                        btn.innerHTML = 'üìç Use My Location';
                        btn.disabled = false;
                        
                        // Try IP-based geolocation as fallback
                        if (error.code === error.POSITION_UNAVAILABLE || error.code === error.TIMEOUT) {
                            console.log('Trying IP-based geolocation as fallback...');
                            fetch('https://ipapi.co/json/')
                                .then(r => r.json())
                                .then(data => {
                                    if (data.city && data.region) {
                                        const location = `${data.city}, ${data.region}`;
                                        document.getElementById('quickLocation').value = location;
                                        console.log(`IP geolocation successful: ${location}`);
                                        alert(`Location detected from IP: ${location}\n\nYou can change it manually if needed.`);
                                    } else {
                                        // Fallback to default
                                        document.getElementById('quickLocation').value = 'Fayetteville, NC';
                                        alert('Location unavailable. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                                    }
                                })
                                .catch(() => {
                                    // Fallback to default
                                    document.getElementById('quickLocation').value = 'Fayetteville, NC';
                                    alert('Location unavailable. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                                });
                        } else if (error.code === error.PERMISSION_DENIED) {
                            alert('Location permission denied.\n\nTo enable:\n‚Ä¢ Safari: Settings > Privacy & Security > Location Services\n‚Ä¢ Chrome: Settings > Privacy > Site Settings > Location\n‚Ä¢ Firefox: Settings > Privacy > Permissions > Location');
                        } else {
                            document.getElementById('quickLocation').value = 'Fayetteville, NC';
                            alert('Location error. Using Fayetteville, NC as default.\n\nYou can change it manually.');
                        }
                    },
                    {
                        enableHighAccuracy: false,  // Changed to false for faster response
                        timeout: 5000,              // Reduced timeout
                        maximumAge: 0               // Always get fresh location
                    }
                );
            } else {
                btn.innerHTML = 'üìç Use My Location';
                btn.disabled = false;
                alert('Geolocation is not supported by your browser. Please enter your location manually.');
                document.getElementById('quickLocation').value = 'Fayetteville, NC';
            }
        }

        // Generate date with dynamic content based on input
        function generateDate() {
            // Collect data from wizard
            if (document.getElementById('locationInput')) {
                dateData.location = document.getElementById('locationInput').value;
            }
            if (document.getElementById('preferences')) {
                dateData.preferences = document.getElementById('preferences').value;
            }
            
            // Collect data from classic form
            if (formMode === 'classic') {
                dateData.location = document.getElementById('quickLocation').value || 'Virginia Beach';
                dateData.budget = parseInt(document.getElementById('quickBudget').value) || 100;
            }

            // Show loading state
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-flex items-center justify-center">
                        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    </div>
                    <p class="mt-4 text-gray-600">Generating your perfect date ideas...</p>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
            
            // Simulate API call delay
            setTimeout(() => {
                // Restore results structure
                resultsDiv.innerHTML = `
                    <!-- Interactive Map -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Interactive Map</h3>
                            <button onclick="addMarkersToMap()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                üó∫Ô∏è Refresh Markers
                            </button>
                            <button onclick="forceRefreshCoordinates()" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                üìç Fix Coordinates
                            </button>
                        </div>
                        <div id="map" class="h-96 rounded-lg"></div>
                    </div>

                    <!-- Draggable Timeline -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Your Date Timeline</h3>
                            <div class="flex space-x-2">
                                <button onclick="saveDate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    üíæ Save
                                </button>
                                <button onclick="shareDate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    üì§ Share
                                </button>
                                <button onclick="exportCalendar()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    üìÖ Export
                                </button>
                            </div>
                        </div>
                        <div id="timeline" class="space-y-4">
                            <!-- Timeline items will be added here -->
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between text-sm">
                                <span>Total Duration: <strong id="totalDuration">0 hours</strong></span>
                                <span>Total Cost: <strong id="totalCost">$0</strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Venue Alternatives -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Alternative Venues</h3>
                        <div id="alternatives" class="grid grid-cols-3 gap-4">
                            <!-- Alternative venues will be added here -->
                        </div>
                    </div>
                `;
                
                // Show results
                document.getElementById('budgetDisplay').classList.remove('hidden');
                
                // Initialize map with delay to ensure DOM is ready
                setTimeout(async () => {
                    initMap();
                    
                    // Create dynamic timeline based on input  
                    await createDynamicTimeline();
                    
                    // Ensure markers are added with multiple attempts
                    setTimeout(() => {
                        console.log('Ensuring markers are visible after timeline creation...');
                        addMarkersToMap();
                    }, 300);
                    
                    setTimeout(() => {
                        console.log('Second marker attempt...');
                        addMarkersToMap();
                    }, 800);
                }, 100);
                
                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            }, 1500);
        }

        // Create dynamic timeline based on user input
        async function createDynamicTimeline() {
            const eventType = dateData.eventType || 'casual_dating';
            const budget = dateData.budget || 100;
            const hours = dateData.timeAvailable || 4;
            const vibes = dateData.vibes || [];
            
            // Get user's coordinates or use default
            let baseLat = 35.0526; // Default Fayetteville, NC
            let baseLng = -78.8783;
            
            // Try to get actual user location from map center
            if (map) {
                const center = map.getCenter();
                baseLat = center.lat;
                baseLng = center.lng;
                console.log(`Using map center coordinates: ${baseLat}, ${baseLng}`);
            } else {
                console.log(`Using default Fayetteville coordinates: ${baseLat}, ${baseLng}`);
            }
            
            try {
                // Call backend API to generate real places
                const response = await fetch('/api/generate-date', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: `${baseLat}, ${baseLng}`,
                        budget: budget,
                        event_type: eventType,
                        vibes: vibes,
                        time_available: hours
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.activities) {
                        // Transform backend activities to frontend format
                        timeline = result.activities.map((activity, index) => ({
                            time: activity.time,
                            activity: activity.activity,
                            businessName: activity.place_name || activity.activity,
                            cost: activity.estimated_cost || 50,
                            location: [activity.location.lat, activity.location.lng],
                            address: activity.address,
                            rating: activity.rating,
                            phone: activity.phone,
                            website: activity.website,
                            hours: activity.open_now ? 'Open Now' : 'Check Hours'
                        }));
                        
                        console.log('Generated timeline with real Google Places:', timeline);
                        renderTimeline();
                        addMarkersToMap();
                        return;
                    }
                }
            } catch (error) {
                console.error('Failed to get real places from API:', error);
                alert('Unable to generate date recommendations. Please check your internet connection and try again.');
                return;
            }
        }

        // Initialize interactive map with user's location
        function initMap() {
            // Always reset map since DOM gets recreated in generateDate
            map = null;
            markers = [];
            
            // Try to get user's actual location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            map = L.map('map').setView([userLat, userLng], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '¬© OpenStreetMap contributors'
                            }).addTo(map);
                            
                            // Add marker for user location
                            L.marker([userLat, userLng])
                                .addTo(map)
                                .bindPopup('üìç Your Location')
                                .openPopup();
                        },
                        (error) => {
                            // Fallback to default location
                            console.log('Geolocation failed, using default');
                            map = L.map('map').setView([35.0526, -78.8783], 13); // Default to Fayetteville, NC
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '¬© OpenStreetMap contributors'
                            }).addTo(map);
                        }
                    );
                } else {
                    // Fallback if geolocation not available
                    map = L.map('map').setView([35.0526, -78.8783], 13); // Default to Fayetteville, NC
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);
                }
        }


        function renderTimeline() {
            const timelineEl = document.getElementById('timeline');
            timelineEl.innerHTML = '';
            
            timeline.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'timeline-item bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg cursor-move';
                div.dataset.index = index;
                div.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start space-x-3 flex-1">
                                <span class="text-2xl">üìç</span>
                                <div class="flex-1">
                                    <div class="font-bold text-xl text-indigo-700 editable" contenteditable="true" data-field="businessName">${item.businessName || item.activity}</div>
                                    <div class="text-gray-700 text-md mt-1 editable" contenteditable="true" data-field="activity">${item.activity}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        <span class="editable" contenteditable="true" data-field="time">${item.time}</span> ‚Ä¢ 
                                        $<span class="editable" contenteditable="true" data-field="cost">${item.cost}</span>
                                    </div>
                                    
                                    <!-- Business Information -->
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg" id="business-info-${index}">
                                        <div class="text-sm space-y-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-700">üìç Address:</span>
                                                <span class="text-gray-600">${item.address || getBusinessAddress(item.businessName)}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-700">‚≠ê Rating:</span>
                                                <span class="text-yellow-600">${item.rating || generateMockRating()} ${item.rating ? '' : `(${Math.floor(Math.random() * 200 + 50)} reviews)`}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-700">üïí Hours:</span>
                                                <span class="text-green-600">${item.hours || generateMockHours()}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-700">üìû Phone:</span>
                                                <span class="text-blue-600">${item.phone || generateMockPhone()}</span>
                                            </div>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <div class="relative">
                                                    <button onclick="showDirectionsMenu(${item.location[0]}, ${item.location[1]}, ${index})" class="text-blue-600 hover:underline text-xs bg-blue-50 px-2 py-1 rounded">üó∫Ô∏è Directions</button>
                                                    <div id="directions-menu-${index}" class="hidden absolute top-6 left-0 bg-white border rounded shadow-lg z-10 min-w-36">
                                                        <a href="#" onclick="openSmartMaps(${item.location[0]}, ${item.location[1]})" class="block px-3 py-2 text-xs hover:bg-blue-100 font-medium border-b">üéØ Auto-detect</a>
                                                        <a href="#" onclick="openAppleMaps(${item.location[0]}, ${item.location[1]})" class="block px-3 py-2 text-xs hover:bg-gray-100">üçé Apple Maps</a>
                                                        <a href="#" onclick="openGoogleMaps(${item.location[0]}, ${item.location[1]})" class="block px-3 py-2 text-xs hover:bg-gray-100">üåê Google Maps</a>
                                                    </div>
                                                </div>
                                                <a href="#" onclick="callBusiness('${item.phone || generateMockPhone()}')" class="text-green-600 hover:underline text-xs bg-green-50 px-2 py-1 rounded">üìû Call</a>
                                                ${item.website ? `<a href="${item.website}" target="_blank" class="text-purple-600 hover:underline text-xs bg-purple-50 px-2 py-1 rounded">üåê Website</a>` : `<a href="#" onclick="viewWebsite('${item.businessName || item.activity}')" class="text-purple-600 hover:underline text-xs bg-purple-50 px-2 py-1 rounded">üåê Search</a>`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="swapVenue(${index})" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 text-sm font-semibold transition-all transform hover:scale-105 shadow-lg">
                                    üîÑ Find Alternatives
                                </button>
                                <button onclick="removeActivity(${index})" class="px-3 py-1 bg-white text-red-600 rounded hover:bg-red-50 text-sm">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                timelineEl.appendChild(div);
            });

            // Make timeline sortable
            new Sortable(timelineEl, {
                animation: 150,
                ghostClass: 'dragging',
                onEnd: function(evt) {
                    // Reorder timeline array
                    const item = timeline.splice(evt.oldIndex, 1)[0];
                    timeline.splice(evt.newIndex, 0, item);
                    updateTotals();
                }
            });

            // Add inline editing
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('blur', function() {
                    const index = this.closest('.timeline-item').dataset.index;
                    const field = this.dataset.field;
                    const value = field === 'cost' ? parseFloat(this.textContent) : this.textContent;
                    timeline[index][field] = value;
                    updateTotals();
                });
            });

            updateTotals();
        }

        function updateTotals() {
            const totalCost = timeline.reduce((sum, item) => sum + (item.cost || 0), 0);
            const totalHours = timeline.length * 1.5; // Estimate 1.5 hours per activity
            
            document.getElementById('totalCost').textContent = `$${totalCost}`;
            document.getElementById('totalDuration').textContent = `${totalHours} hours`;
            document.getElementById('currentBudget').textContent = totalCost;
        }

        function addMarkersToMap() {
            if (!map) {
                console.warn('Map not initialized when trying to add markers');
                return;
            }
            
            if (!timeline || timeline.length === 0) {
                console.warn('No timeline data available for markers');
                return;
            }
            
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            console.log(`Adding ${timeline.length} markers to map:`);
            
            // Add new markers
            timeline.forEach((item, index) => {
                if (!item.location || !Array.isArray(item.location) || item.location.length !== 2) {
                    console.warn(`Invalid location data for item ${index}:`, item);
                    return;
                }
                
                console.log(`Marker ${index}: ${item.businessName || item.activity} at [${item.location[0]}, ${item.location[1]}]`);
                
                const businessAddress = item.address || getBusinessAddress(item.businessName);
                const businessPhone = item.phone || generateMockPhone();
                const marker = L.marker(item.location)
                    .addTo(map)
                    .bindPopup(`
                        <div class="p-4 min-w-64 max-w-80">
                            <div class="font-bold text-xl text-indigo-700 mb-2">${item.businessName || item.activity}</div>
                            <div class="text-gray-700 font-medium mb-3">${item.activity}</div>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center space-x-2">
                                    <span class="font-medium text-gray-600">üìç</span>
                                    <span class="text-gray-800">${businessAddress}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-medium text-gray-600">‚è∞</span>
                                    <span class="text-gray-800">${item.time}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-medium text-gray-600">üí∞</span>
                                    <span class="text-gray-800">$${item.cost}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-medium text-gray-600">üìã</span>
                                    <span class="text-gray-800">Step ${index + 1} of ${timeline.length}</span>
                                </div>
                            </div>
                            
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button onclick="scrollToTimelineItem(${index})" class="px-3 py-1 bg-indigo-600 text-white rounded-md text-xs hover:bg-indigo-700 transition">
                                    üëÅÔ∏è View Details
                                </button>
                                <button onclick="openSmartMaps(${item.location[0]}, ${item.location[1]})" class="px-3 py-1 bg-blue-600 text-white rounded-md text-xs hover:bg-blue-700 transition">
                                    üß≠ Directions
                                </button>
                                <button onclick="callBusiness('${businessPhone}')" class="px-3 py-1 bg-green-600 text-white rounded-md text-xs hover:bg-green-700 transition">
                                    üìû Call
                                </button>
                            </div>
                        </div>
                    `);
                markers.push(marker);
            });

            // Draw route between markers
            if (markers.length > 1) {
                const latlngs = timeline.map(item => item.location);
                L.polyline(latlngs, { color: 'indigo', weight: 3, opacity: 0.7 }).addTo(map);
            }

            // Fit map to markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                const bounds = group.getBounds();
                console.log(`Fitting map to ${markers.length} markers`, bounds);
                map.fitBounds(bounds.pad(0.1));
                
                // Force map refresh
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            } else {
                console.warn('No markers to display on map');
            }
        }

        async function swapVenue(index) {
            const currentActivity = timeline[index];
            
            // Show loading state
            document.getElementById('alternatives').innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Finding great alternatives for ${currentActivity.businessName || currentActivity.activity}...</p>
                </div>
            `;
            document.getElementById('alternatives').scrollIntoView({ behavior: 'smooth' });
            
            // Get current location
            let searchLocation = "Fayetteville, NC";
            if (map) {
                const center = map.getCenter();
                searchLocation = `${center.lat}, ${center.lng}`;
            }
            
            try {
                // Call backend API to search for real alternative venues
                const activityQuery = getSearchQuery(currentActivity.activity);
                const response = await fetch(`/api/search-places?query=${encodeURIComponent(activityQuery)}&location=${encodeURIComponent(searchLocation)}&radius=5000`);

                if (response.ok) {
                    const result = await response.json();
                    if (result.places && result.places.length > 0) {
                        // Use real Google Places data
                        const alternatives = result.places.map(place => ({
                            name: place.name,
                            rating: place.rating ? `${place.rating}/5` : 'No rating',
                            priceLevel: getPriceLevel(place.price_level),
                            distance: '0.5 mi', // Could calculate actual distance
                            address: place.address || 'Address not available',
                            phone: place.phone || '(910) 555-0123',
                            hours: 'Check hours online',
                            description: `Highly rated ${activityQuery.toLowerCase()} venue with great reviews`,
                            location: place.location,
                            place_id: place.place_id
                        }));
                        
                        displayAlternatives(index, currentActivity, alternatives);
                        return;
                    }
                }
            } catch (error) {
                console.error('Failed to get real alternative venues:', error);
            }

            // Fallback to mock alternatives
            console.log('Using fallback mock alternatives');
            setTimeout(() => {
                const alternatives = generateAlternativeVenues(currentActivity.activity);
                displayAlternatives(index, currentActivity, alternatives);
            }, 800);
        }

        function getSearchQuery(activity) {
            // Convert activity description to search query
            if (activity.toLowerCase().includes('coffee') || activity.toLowerCase().includes('cafe')) {
                return 'coffee shop';
            } else if (activity.toLowerCase().includes('lunch') || activity.toLowerCase().includes('dinner') || activity.toLowerCase().includes('food')) {
                return 'restaurant';
            } else if (activity.toLowerCase().includes('drinks') || activity.toLowerCase().includes('bar')) {
                return 'bar';
            } else if (activity.toLowerCase().includes('arcade') || activity.toLowerCase().includes('games')) {
                return 'arcade';
            } else if (activity.toLowerCase().includes('bowling')) {
                return 'bowling alley';
            } else if (activity.toLowerCase().includes('spa')) {
                return 'spa';
            } else if (activity.toLowerCase().includes('entertainment')) {
                return 'entertainment venue';
            } else {
                return activity.toLowerCase();
            }
        }

        function getPriceLevel(priceLevel) {
            switch(priceLevel) {
                case 1: return '$';
                case 2: return '$$';
                case 3: return '$$$';
                case 4: return '$$$$';
                default: return '$$';
            }
        }

        function displayAlternatives(index, currentActivity, alternatives) {
            const altHtml = alternatives.map((alt, altIndex) => `
                <div class="venue-card p-5 bg-white rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-all border-2 border-transparent hover:border-indigo-200 transform hover:-translate-y-1" onclick="replaceVenue(${index}, ${altIndex})">
                    <div class="space-y-3">
                        <div class="flex items-start justify-between">
                            <div class="font-bold text-lg text-gray-900">${alt.name}</div>
                            <div class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Available</div>
                        </div>
                        <div class="flex items-center space-x-4 text-sm">
                            <span class="text-yellow-600 font-medium">‚≠ê ${alt.rating}</span>
                            <span class="text-gray-600">${alt.priceLevel}</span>
                            <span class="text-blue-600">${alt.distance}</span>
                        </div>
                        <div class="text-sm text-gray-600 leading-relaxed">${alt.address}</div>
                        <div class="text-sm flex items-center space-x-2">
                            <span class="font-medium">üìû</span> 
                            <span class="text-blue-600">${alt.phone}</span>
                        </div>
                        <div class="text-xs text-green-600 font-medium">${alt.hours}</div>
                        <div class="text-sm text-gray-700 leading-relaxed">${alt.description}</div>
                        <div class="pt-2 border-t border-gray-100">
                            <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                üè† Select This Venue ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('alternatives').innerHTML = `
                <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl">
                    <h4 class="font-bold text-xl text-gray-900 mb-2">‚ú® Alternative venues for "${currentActivity.businessName || currentActivity.activity}"</h4>
                    <p class="text-gray-600">Found ${alternatives.length} great options nearby. Click any venue to replace it in your timeline!</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${altHtml}
                </div>
            `;
        }

        function generateAlternativeVenues(currentActivity) {
            // Generate different alternatives based on activity type
            const venueTypes = {
                'coffee': ['Blue Moon Cafe', 'Roasted Bean Coffee', 'The Daily Grind', 'Corner Coffee Shop'],
                'restaurant': ['Bella Vista Italian', 'The Steakhouse', 'Garden Bistro', 'Local Farm Table'],
                'bar': ['The Tap Room', 'Vintage Wine Bar', 'Craft Beer Hall', 'Cocktail Lounge'],
                'entertainment': ['Zone Entertainment', 'GameTime Arcade', 'Strike Zone Bowling', 'Fun Factory'],
                'default': ['Popular Local Spot', 'Trending Venue', 'Customer Favorite', 'Hidden Gem']
            };

            let categoryOptions = venueTypes.default;
            if (currentActivity.toLowerCase().includes('coffee') || currentActivity.toLowerCase().includes('cafe')) {
                categoryOptions = venueTypes.coffee;
            } else if (currentActivity.toLowerCase().includes('lunch') || currentActivity.toLowerCase().includes('dinner') || currentActivity.toLowerCase().includes('bistro')) {
                categoryOptions = venueTypes.restaurant;
            } else if (currentActivity.toLowerCase().includes('drinks') || currentActivity.toLowerCase().includes('bar')) {
                categoryOptions = venueTypes.bar;
            } else if (currentActivity.toLowerCase().includes('arcade') || currentActivity.toLowerCase().includes('games') || currentActivity.toLowerCase().includes('bowling')) {
                categoryOptions = venueTypes.entertainment;
            }

            return categoryOptions.map(name => ({
                name: name,
                rating: generateMockRating(),
                priceLevel: ['$', '$$', '$$$'][Math.floor(Math.random() * 3)],
                distance: `${(Math.random() * 2 + 0.1).toFixed(1)} mi`,
                address: generateMockAddress(),
                phone: generateMockPhone(),
                hours: generateMockHours(),
                description: generateVenueDescription(name)
            }));
        }

        function generateVenueDescription(name) {
            const descriptions = [
                'Highly rated local favorite with great atmosphere',
                'Known for excellent service and quality',
                'Popular spot with locals and visitors alike',
                'Cozy setting perfect for a great time',
                'Award-winning establishment with unique charm',
                'Modern venue with classic touches'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function replaceVenue(timelineIndex, venueIndex) {
            const alternatives = generateAlternativeVenues(timeline[timelineIndex].activity);
            const newVenue = alternatives[venueIndex];
            
            // Update timeline with new venue business name
            timeline[timelineIndex].businessName = newVenue.name;
            
            // Clear alternatives section with success animation
            document.getElementById('alternatives').innerHTML = `
                <div class="text-center py-12 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Venue Updated Successfully!</h3>
                    <p class="text-green-700 mb-4">Your timeline now includes <strong>${newVenue.name}</strong></p>
                    <p class="text-sm text-gray-600">Click "üîÑ Find Alternatives" on any activity to see more options.</p>
                </div>
            `;
            
            renderTimeline();
            addMarkersToMap();
        }

        function removeActivity(index) {
            timeline.splice(index, 1);
            renderTimeline();
            addMarkersToMap();
        }

        function saveDate() {
            const dateStr = JSON.stringify({ timeline, dateData });
            localStorage.setItem('savedDate', dateStr);
            alert('Date saved successfully! üíæ');
        }

        function shareDate() {
            const shareUrl = `${window.location.origin}?date=${btoa(JSON.stringify(timeline))}`;
            navigator.clipboard.writeText(shareUrl);
            alert('Share link copied to clipboard! üìã');
        }

        function exportCalendar() {
            // Create iCal format
            let ical = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Perfect Date//EN\n';
            timeline.forEach(item => {
                ical += `BEGIN:VEVENT\nSUMMARY:${item.activity}\nDTSTART:${new Date().toISOString()}\nEND:VEVENT\n`;
            });
            ical += 'END:VCALENDAR';
            
            // Download file
            const blob = new Blob([ical], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'perfect-date.ics';
            a.click();
        }

        // Generate realistic business information
        function generateMockAddress(location) {
            const streetNumbers = [123, 456, 789, 1234, 567];
            const streetNames = ['Main St', 'Oak Ave', 'Elm Dr', 'Pine Rd', 'Cedar Way', 'Market St', 'University Dr'];
            const number = streetNumbers[Math.floor(Math.random() * streetNumbers.length)];
            const street = streetNames[Math.floor(Math.random() * streetNames.length)];
            return `${number} ${street}, Fayetteville, NC`;
        }

        function generateMockRating() {
            const ratings = ['4.2', '4.5', '4.1', '4.7', '4.3', '4.6', '4.4'];
            return ratings[Math.floor(Math.random() * ratings.length)];
        }

        function generateMockHours() {
            const currentHour = new Date().getHours();
            if (currentHour >= 9 && currentHour < 22) {
                return 'Open now ‚Ä¢ Closes 10:00 PM';
            } else if (currentHour >= 22 || currentHour < 6) {
                return 'Closed ‚Ä¢ Opens 9:00 AM';
            } else {
                return 'Opens soon ‚Ä¢ 9:00 AM';
            }
        }

        function generateMockPhone() {
            return `(910) ${Math.floor(Math.random() * 900 + 100)}-${Math.floor(Math.random() * 9000 + 1000)}`;
        }

        // Business interaction functions
        function showDirectionsMenu(lat, lng, index) {
            // Hide all other direction menus first
            document.querySelectorAll('[id^="directions-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
            
            // Show the clicked menu
            const menu = document.getElementById(`directions-menu-${index}`);
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!e.target.closest(`#directions-menu-${index}`) && !e.target.closest(`button[onclick*="showDirectionsMenu"]`)) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        function openAppleMaps(lat, lng) {
            // Hide any open menus
            document.querySelectorAll('[id^="directions-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
            
            // Apple Maps URL scheme
            const url = `http://maps.apple.com/?daddr=${lat},${lng}&dirflg=d`;
            window.open(url, '_blank');
        }

        function openGoogleMaps(lat, lng) {
            // Hide any open menus
            document.querySelectorAll('[id^="directions-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
            
            // Google Maps URL
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        function openSmartMaps(lat, lng) {
            // Hide any open menus
            document.querySelectorAll('[id^="directions-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
            
            // Detect device and open appropriate maps app
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // Check if it's an iOS device
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                // iOS device - prefer Apple Maps
                openAppleMaps(lat, lng);
            } else if (/android/i.test(userAgent)) {
                // Android device - prefer Google Maps
                openGoogleMaps(lat, lng);
            } else {
                // Desktop or other - use Google Maps
                openGoogleMaps(lat, lng);
            }
        }

        function callBusiness(phone) {
            window.location.href = `tel:${phone}`;
        }

        function viewWebsite(businessName) {
            // Generate a mock website or search
            const searchQuery = encodeURIComponent(businessName + ' Fayetteville NC');
            const url = `https://www.google.com/search?q=${searchQuery}`;
            window.open(url, '_blank');
        }

        function scrollToTimelineItem(index) {
            // Scroll to the specific timeline item
            const timelineItems = document.querySelectorAll('.timeline-item');
            if (timelineItems[index]) {
                timelineItems[index].scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Highlight the item temporarily
                timelineItems[index].style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                timelineItems[index].style.color = 'white';
                timelineItems[index].style.transform = 'scale(1.02)';
                timelineItems[index].style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    timelineItems[index].style.background = '';
                    timelineItems[index].style.color = '';
                    timelineItems[index].style.transform = '';
                }, 2000);
            }
        }

        function forceRefreshCoordinates() {
            console.log('Forcing coordinate refresh...');
            
            // Update all timeline items with fresh coordinates
            timeline.forEach((item, index) => {
                if (item.businessName) {
                    const newLocation = getBusinessLocation(item.businessName);
                    item.location = newLocation;
                    console.log(`Updated ${item.businessName} to coordinates: [${newLocation[0]}, ${newLocation[1]}]`);
                }
            });
            
            // Refresh the map
            addMarkersToMap();
            
            // Show notification
            alert('üìç Coordinates updated to accurate locations!');
        }

        // Quick vibe selection for classic form
        document.querySelectorAll('.quick-vibe').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('bg-indigo-600');
                btn.classList.toggle('text-white');
                btn.classList.toggle('border-gray-300');
                const vibe = btn.dataset.vibe;
                if (!dateData.vibes) dateData.vibes = [];
                if (dateData.vibes.includes(vibe)) {
                    dateData.vibes = dateData.vibes.filter(v => v !== vibe);
                } else {
                    dateData.vibes.push(vibe);
                }
            });
        });

        // Classic form submission
        document.getElementById('dateForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Collect all form data
            dateData.location = document.getElementById('quickLocation').value || 'Virginia Beach';
            dateData.budget = parseInt(document.getElementById('quickBudget').value) || 100;
            dateData.eventType = document.getElementById('quickEventType').value;
            
            // Vibes are already collected via click handlers
            
            generateDate();
        });

        // Check for shared date in URL on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedDate = urlParams.get('date');
            if (sharedDate) {
                try {
                    const decodedTimeline = JSON.parse(atob(sharedDate));
                    
                    // Update coordinates to current location (Fayetteville)
                    const baseLat = 35.0526;
                    const baseLng = -78.8783;
                    
                    decodedTimeline.forEach((item, index) => {
                        // Update coordinates to use real business locations
                        if (item.businessName) {
                            const realLocation = getBusinessLocation(item.businessName);
                            item.location = realLocation;
                        } else {
                            // Fallback to downtown Fayetteville if no business name
                            item.location = [35.0526, -78.8783];
                        }
                    });
                    
                    timeline = decodedTimeline;
                    
                    console.log('Loaded shared timeline with updated coordinates:', timeline);
                    
                    // Show the results section
                    document.getElementById('results').classList.remove('hidden');
                    document.getElementById('formWizard').classList.add('hidden');
                    document.getElementById('simpleForm').classList.add('hidden');
                    
                    // Initialize map and render timeline
                    initMap();
                    renderTimeline();
                    
                    // Wait for map to be ready, then add markers multiple times to ensure they show
                    setTimeout(() => {
                        console.log('First attempt to add markers...');
                        addMarkersToMap();
                    }, 500);
                    
                    setTimeout(() => {
                        console.log('Second attempt to add markers...');
                        addMarkersToMap();
                    }, 1000);
                    
                    setTimeout(() => {
                        console.log('Final attempt to add markers...');
                        addMarkersToMap();
                    }, 2000);
                    
                    // Scroll to results
                    setTimeout(() => {
                        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                    
                    // Show notification
                    setTimeout(() => {
                        alert('üì¨ Shared date loaded successfully!');
                    }, 1000);
                } catch (error) {
                    console.error('Error loading shared date:', error);
                    alert('‚ùå Invalid share link');
                }
            }
        });
    </script>
</body>
</html>